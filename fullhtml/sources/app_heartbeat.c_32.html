
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_heartbeat.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file app_heartbeat.c</a>
<a name="ln3"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln4"> * @date 2020-06-17</a>
<a name="ln5"> * @copyright Ruuvi Innovations Ltd, License BSD-3-Clause.</a>
<a name="ln6"> */</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;app_config.h&quot;</a>
<a name="ln9">#include &quot;app_comms.h&quot;</a>
<a name="ln10">#include &quot;app_dataformats.h&quot;</a>
<a name="ln11">#include &quot;app_heartbeat.h&quot;</a>
<a name="ln12">#include &quot;app_led.h&quot;</a>
<a name="ln13">#include &quot;app_log.h&quot;</a>
<a name="ln14">#include &quot;app_sensor.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_driver_sensor.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_endpoint_5.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_rtc.h&quot;</a>
<a name="ln21">#include &quot;ruuvi_interface_scheduler.h&quot;</a>
<a name="ln22">#include &quot;ruuvi_interface_timer.h&quot;</a>
<a name="ln23">#include &quot;ruuvi_interface_watchdog.h&quot;</a>
<a name="ln24">#include &quot;ruuvi_task_adc.h&quot;</a>
<a name="ln25">#include &quot;ruuvi_task_advertisement.h&quot;</a>
<a name="ln26">#include &quot;ruuvi_task_gatt.h&quot;</a>
<a name="ln27">#include &quot;ruuvi_task_nfc.h&quot;</a>
<a name="ln28"> </a>
<a name="ln29">#define U8_MASK (0xFFU)</a>
<a name="ln30">#define APP_DF_3_ENABLED 0</a>
<a name="ln31">#define APP_DF_5_ENABLED 1</a>
<a name="ln32">#define APP_DF_8_ENABLED 0</a>
<a name="ln33">#define APP_DF_FA_ENABLED 0</a>
<a name="ln34"> </a>
<a name="ln35">static ri_timer_id_t heart_timer; //!&lt; Timer for updating data.</a>
<a name="ln36"> </a>
<a name="ln37">static uint64_t last_heartbeat_timestamp_ms; //!&lt; Timestamp for heartbeat refresh.</a>
<a name="ln38"> </a>
<a name="ln39">static app_dataformat_t m_dataformat_state; //!&lt; State of heartbeat.</a>
<a name="ln40"> </a>
<a name="ln41">static app_dataformats_t m_dataformats_enabled =</a>
<a name="ln42">{</a>
<a name="ln43">    .DF_3  = APP_DF_3_ENABLED,</a>
<a name="ln44">    .DF_5  = APP_DF_5_ENABLED,</a>
<a name="ln45">    .DF_8  = APP_DF_8_ENABLED,</a>
<a name="ln46">    .DF_FA = APP_DF_FA_ENABLED</a>
<a name="ln47">}; //!&lt; Flags of enabled formats</a>
<a name="ln48"> </a>
<a name="ln49">static rd_status_t send_adv (ri_comm_message_t * const p_msg)</a>
<a name="ln50">{</a>
<a name="ln51">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln52">    const uint8_t repeat_count = app_comms_bleadv_send_count_get();</a>
<a name="ln53"> </a>
<a name="ln54">    if (APP_COMM_ADV_DISABLE != repeat_count)</a>
<a name="ln55">    {</a>
<a name="ln56">        if (APP_COMM_ADV_REPEAT_FOREVER == repeat_count)</a>
<a name="ln57">        {</a>
<a name="ln58">            p_msg-&gt;repeat_count = RI_COMM_MSG_REPEAT_FOREVER;</a>
<a name="ln59">        }</a>
<a name="ln60">        else</a>
<a name="ln61">        {</a>
<a name="ln62">            p_msg-&gt;repeat_count = repeat_count;</a>
<a name="ln63">        }</a>
<a name="ln64"> </a>
<a name="ln65">        err_code |= rt_adv_send_data (p_msg);</a>
<a name="ln66">    }</a>
<a name="ln67">    else</a>
<a name="ln68">    {</a>
<a name="ln69">        rt_adv_stop();</a>
<a name="ln70">    }</a>
<a name="ln71"> </a>
<a name="ln72">    return err_code;</a>
<a name="ln73">}</a>
<a name="ln74"> </a>
<a name="ln75">/**</a>
<a name="ln76"> * @brief When timer triggers, schedule reading sensors and sending data.</a>
<a name="ln77"> *</a>
<a name="ln78"> * @param[in] p_context Always NULL.</a>
<a name="ln79"> */</a>
<a name="ln80">#ifndef CEEDLING</a>
<a name="ln81">static</a>
<a name="ln82">#endif</a>
<a name="ln83">void heartbeat (void * p_event, uint16_t event_size)</a>
<a name="ln84">{</a>
<a name="ln85">    ri_comm_message_t msg = {0};</a>
<a name="ln86">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln87">    bool heartbeat_ok = false;</a>
<a name="ln88">    rd_sensor_data_t data = { 0 };</a>
<a name="ln89">    size_t buffer_len = RI_COMM_MESSAGE_MAX_LENGTH;</a>
<a name="ln90">    data.fields = app_sensor_available_data();</a>
<a name="ln91">    float data_values[rd_sensor_data_fieldcount (&amp;data)];</a>
<a name="ln92">    data.data = data_values;</a>
<a name="ln93">    app_sensor_get (&amp;data);</a>
<a name="ln94">    // Sensor read takes a long while, indicate activity once data is read.</a>
<a name="ln95">    app_led_activity_signal (true);</a>
<a name="ln96">    m_dataformat_state = app_dataformat_next (m_dataformats_enabled, m_dataformat_state);</a>
<a name="ln97">    app_dataformat_encode (msg.data, &amp;buffer_len, &amp;data, m_dataformat_state);</a>
<a name="ln98">    msg.data_length = (uint8_t) buffer_len;</a>
<a name="ln99">    err_code = send_adv (&amp;msg);</a>
<a name="ln100">    // Advertising should always be successful</a>
<a name="ln101">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln102"> </a>
<a name="ln103">    if (RD_SUCCESS == err_code)</a>
<a name="ln104">    {</a>
<a name="ln105">        heartbeat_ok = true;</a>
<a name="ln106">    }</a>
<a name="ln107"> </a>
<a name="ln108">    // Cut endpoint data to fit into GATT msg.</a>
<a name="ln109">    msg.data_length = 18;</a>
<a name="ln110">    // Gatt Link layer takes care of delivery.</a>
<a name="ln111">    msg.repeat_count = 1;</a>
<a name="ln112">    err_code = rt_gatt_send_asynchronous (&amp;msg);</a>
<a name="ln113"> </a>
<a name="ln114">    if (RD_SUCCESS == err_code)</a>
<a name="ln115">    {</a>
<a name="ln116">        heartbeat_ok = true;</a>
<a name="ln117">    }</a>
<a name="ln118"> </a>
<a name="ln119">    // Restore original message length for NFC</a>
<a name="ln120">    msg.data_length = (uint8_t) buffer_len;</a>
<a name="ln121">    err_code = rt_nfc_send (&amp;msg);</a>
<a name="ln122"> </a>
<a name="ln123">    if (RD_SUCCESS == err_code)</a>
<a name="ln124">    {</a>
<a name="ln125">        heartbeat_ok = true;</a>
<a name="ln126">    }</a>
<a name="ln127"> </a>
<a name="ln128">    if (heartbeat_ok)</a>
<a name="ln129">    {</a>
<a name="ln130">        ri_watchdog_feed();</a>
<a name="ln131">        last_heartbeat_timestamp_ms = ri_rtc_millis();</a>
<a name="ln132">    }</a>
<a name="ln133"> </a>
<a name="ln134">    // Turn LED off before starting lengthy flash operations</a>
<a name="ln135">    app_led_activity_signal (false);</a>
<a name="ln136">    err_code = app_log_process (&amp;data);</a>
<a name="ln137">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln138">}</a>
<a name="ln139"> </a>
<a name="ln140">/**</a>
<a name="ln141"> * @brief When timer triggers, schedule reading sensors and sending data.</a>
<a name="ln142"> *</a>
<a name="ln143"> * @param[in] p_context Always NULL.</a>
<a name="ln144"> */</a>
<a name="ln145">#ifndef CEEDLING</a>
<a name="ln146">static</a>
<a name="ln147">#endif</a>
<a name="ln148">void schedule_heartbeat_isr (void * const p_context)</a>
<a name="ln149">{</a>
<a name="ln150">    ri_scheduler_event_put (NULL, 0U, &amp;heartbeat);</a>
<a name="ln151">}</a>
<a name="ln152"> </a>
<a name="ln153">rd_status_t app_heartbeat_init (void)</a>
<a name="ln154">{</a>
<a name="ln155">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln156"> </a>
<a name="ln157">    if ( (!ri_timer_is_init()) || (!ri_scheduler_is_init()))</a>
<a name="ln158">    {</a>
<a name="ln159">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln160">    }</a>
<a name="ln161">    else</a>
<a name="ln162">    {</a>
<a name="ln163">        err_code |= ri_timer_create (&amp;heart_timer, RI_TIMER_MODE_REPEATED,</a>
<a name="ln164">                                     &amp;schedule_heartbeat_isr);</a>
<a name="ln165"> </a>
<a name="ln166">        if (RD_SUCCESS == err_code)</a>
<a name="ln167">        {</a>
<a name="ln168">            err_code |= ri_timer_start (heart_timer, APP_HEARTBEAT_INTERVAL_MS, NULL);</a>
<a name="ln169">        }</a>
<a name="ln170">    }</a>
<a name="ln171"> </a>
<a name="ln172">    return err_code;</a>
<a name="ln173">}</a>
<a name="ln174"> </a>
<a name="ln175">rd_status_t app_heartbeat_start (void)</a>
<a name="ln176">{</a>
<a name="ln177">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln178"> </a>
<a name="ln179">    if (NULL == heart_timer)</a>
<a name="ln180">    {</a>
<a name="ln181">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln182">    }</a>
<a name="ln183">    else</a>
<a name="ln184">    {</a>
<a name="ln185">        heartbeat (NULL, 0);</a>
<a name="ln186">        err_code |= ri_timer_start (heart_timer, APP_HEARTBEAT_INTERVAL_MS, NULL);</a>
<a name="ln187">    }</a>
<a name="ln188"> </a>
<a name="ln189">    return err_code;</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192">rd_status_t app_heartbeat_stop (void)</a>
<a name="ln193">{</a>
<a name="ln194">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln195"> </a>
<a name="ln196">    if (NULL == heart_timer)</a>
<a name="ln197">    {</a>
<a name="ln198">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln199">    }</a>
<a name="ln200">    else</a>
<a name="ln201">    {</a>
<a name="ln202">        err_code |= ri_timer_stop (heart_timer);</a>
<a name="ln203">    }</a>
<a name="ln204"> </a>
<a name="ln205">    return err_code;</a>
<a name="ln206">}</a>
<a name="ln207"> </a>
<a name="ln208">bool app_heartbeat_overdue (void)</a>
<a name="ln209">{</a>
<a name="ln210">    return ri_rtc_millis() &gt; (last_heartbeat_timestamp_ms +</a>
<a name="ln211">                              APP_HEARTBEAT_OVERDUE_INTERVAL_MS);</a>
<a name="ln212">}</a>
<a name="ln213"> </a>
<a name="ln214">#ifdef CEEDLING</a>
<a name="ln215">// Give CEEDLING a handle to state of module.</a>
<a name="ln216">ri_timer_id_t * get_heart_timer (void)</a>
<a name="ln217">{</a>
<a name="ln218">    return &amp;heart_timer;</a>
<a name="ln219">}</a>
<a name="ln220">#endif</a>

</code></pre>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2598/" target="_blank">V2598</a> Variable-length array types should not be used. Check the array size expression: '[rd_sensor_data_fieldcount(& data)]'.</p></div>
<div class="balloon" rel="105"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="109"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="111"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="116"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="125"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="81"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'event_size'.</p></div>
<div class="balloon" rel="81"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_event'.</p></div>
<div class="balloon" rel="146"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_context'.</p></div>
<div class="balloon" rel="168"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '*' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="186"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '*' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
