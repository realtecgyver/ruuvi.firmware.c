
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_dataformats.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;app_dataformats.h&quot;</a>
<a name="ln2">#include &quot;app_sensor.h&quot;</a>
<a name="ln3">#include &quot;ruuvi_endpoints.h&quot;</a>
<a name="ln4">#include &quot;ruuvi_endpoint_3.h&quot;</a>
<a name="ln5">#include &quot;ruuvi_endpoint_5.h&quot;</a>
<a name="ln6">#include &quot;ruuvi_endpoint_8.h&quot;</a>
<a name="ln7">#include &quot;ruuvi_endpoint_fa.h&quot;</a>
<a name="ln8">#include &quot;ruuvi_interface_aes.h&quot;</a>
<a name="ln9">#include &quot;ruuvi_interface_communication_ble_advertising.h&quot;</a>
<a name="ln10">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln11">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln12">#include &quot;ruuvi_task_adc.h&quot;</a>
<a name="ln13"> </a>
<a name="ln14">#include &lt;math.h&gt;</a>
<a name="ln15">#include &lt;string.h&gt;</a>
<a name="ln16"> </a>
<a name="ln17">#ifdef CEEDLING</a>
<a name="ln18">#   define TESTABLE_STATIC</a>
<a name="ln19">#else</a>
<a name="ln20">#   define TESTABLE_STATIC static</a>
<a name="ln21">#endif</a>
<a name="ln22"> </a>
<a name="ln23">#if (RE_8_ENABLED || RE_FA_ENABLED)</a>
<a name="ln24">uint32_t app_data_encrypt (const uint8_t * const cleartext,</a>
<a name="ln25">                           uint8_t * const ciphertext,</a>
<a name="ln26">                           const size_t data_size,</a>
<a name="ln27">                           const uint8_t * const key,</a>
<a name="ln28">                           const size_t key_size)</a>
<a name="ln29">{</a>
<a name="ln30">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln31">    uint32_t ret_code = 0;</a>
<a name="ln32"> </a>
<a name="ln33">    if (16U != key_size)</a>
<a name="ln34">    {</a>
<a name="ln35">        err_code |= RD_ERROR_INVALID_LENGTH;</a>
<a name="ln36">    }</a>
<a name="ln37">    else</a>
<a name="ln38">    {</a>
<a name="ln39">        err_code |= ri_aes_ecb_128_encrypt (cleartext,</a>
<a name="ln40">                                            ciphertext,</a>
<a name="ln41">                                            key,</a>
<a name="ln42">                                            data_size);</a>
<a name="ln43">    }</a>
<a name="ln44"> </a>
<a name="ln45">    if (RD_SUCCESS != err_code)</a>
<a name="ln46">    {</a>
<a name="ln47">        ret_code = 1;</a>
<a name="ln48">    }</a>
<a name="ln49"> </a>
<a name="ln50">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln51">    return ret_code;</a>
<a name="ln52">}</a>
<a name="ln53">#endif</a>
<a name="ln54"> </a>
<a name="ln55">app_dataformat_t app_dataformat_next (const app_dataformats_t formats,</a>
<a name="ln56">                                      const app_dataformat_t state)</a>
<a name="ln57">{</a>
<a name="ln58">    // TODO: Return enabled value instead of hardcoded one</a>
<a name="ln59">    return DF_5;</a>
<a name="ln60">}</a>
<a name="ln61"> </a>
<a name="ln62">#if RE_3_ENABLED</a>
<a name="ln63">TESTABLE_STATIC rd_status_t</a>
<a name="ln64">encode_to_3 (uint8_t * const output,</a>
<a name="ln65">             size_t * const output_length,</a>
<a name="ln66">             const rd_sensor_data_t * const data)</a>
<a name="ln67">{</a>
<a name="ln68">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln69">    re_status_t enc_code = RE_SUCCESS;</a>
<a name="ln70">    re_3_data_t ep_data = {0};</a>
<a name="ln71">    ep_data.accelerationx_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_X_FIELD);</a>
<a name="ln72">    ep_data.accelerationy_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Y_FIELD);</a>
<a name="ln73">    ep_data.accelerationz_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Z_FIELD);</a>
<a name="ln74">    ep_data.humidity_rh       = rd_sensor_data_parse (data, RD_SENSOR_HUMI_FIELD);</a>
<a name="ln75">    ep_data.pressure_pa       = rd_sensor_data_parse (data, RD_SENSOR_PRES_FIELD);</a>
<a name="ln76">    ep_data.temperature_c     = rd_sensor_data_parse (data, RD_SENSOR_TEMP_FIELD);</a>
<a name="ln77">    err_code |= rt_adc_vdd_get (&amp;ep_data.battery_v);</a>
<a name="ln78">    enc_code |= re_3_encode (output, &amp;ep_data, RD_FLOAT_INVALID);</a>
<a name="ln79"> </a>
<a name="ln80">    if (RE_SUCCESS != enc_code)</a>
<a name="ln81">    {</a>
<a name="ln82">        err_code |= RD_ERROR_INTERNAL;</a>
<a name="ln83">    }</a>
<a name="ln84"> </a>
<a name="ln85">    *output_length = RE_3_DATA_LENGTH;</a>
<a name="ln86">    return err_code;</a>
<a name="ln87">}</a>
<a name="ln88">#endif</a>
<a name="ln89"> </a>
<a name="ln90">#if RE_5_ENABLED</a>
<a name="ln91">TESTABLE_STATIC rd_status_t</a>
<a name="ln92">encode_to_5 (uint8_t * const output,</a>
<a name="ln93">             size_t * const output_length,</a>
<a name="ln94">             const rd_sensor_data_t * const data)</a>
<a name="ln95">{</a>
<a name="ln96">    static uint16_t ep_5_measurement_count = 0;</a>
<a name="ln97">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln98">    re_status_t enc_code = RE_SUCCESS;</a>
<a name="ln99">    re_5_data_t ep_data = {0};</a>
<a name="ln100">    ep_5_measurement_count++;</a>
<a name="ln101">    ep_5_measurement_count %= (RE_5_SEQCTR_MAX + 1);</a>
<a name="ln102">    ep_data.accelerationx_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_X_FIELD);</a>
<a name="ln103">    ep_data.accelerationy_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Y_FIELD);</a>
<a name="ln104">    ep_data.accelerationz_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Z_FIELD);</a>
<a name="ln105">    ep_data.humidity_rh       = rd_sensor_data_parse (data, RD_SENSOR_HUMI_FIELD);</a>
<a name="ln106">    ep_data.pressure_pa       = rd_sensor_data_parse (data, RD_SENSOR_PRES_FIELD);</a>
<a name="ln107">    ep_data.temperature_c     = rd_sensor_data_parse (data, RD_SENSOR_TEMP_FIELD);</a>
<a name="ln108">    ep_data.measurement_count = ep_5_measurement_count;</a>
<a name="ln109">    uint8_t mvtctr = (uint8_t) (app_sensor_event_count_get() % (RE_5_MVTCTR_MAX + 1));</a>
<a name="ln110">    ep_data.movement_count    = mvtctr;</a>
<a name="ln111">    err_code |= ri_radio_address_get (&amp;ep_data.address);</a>
<a name="ln112">    err_code |= ri_adv_tx_power_get (&amp;ep_data.tx_power);</a>
<a name="ln113">    err_code |= rt_adc_vdd_get (&amp;ep_data.battery_v);</a>
<a name="ln114">    enc_code |= re_5_encode (output, &amp;ep_data);</a>
<a name="ln115"> </a>
<a name="ln116">    if (RE_SUCCESS != enc_code)</a>
<a name="ln117">    {</a>
<a name="ln118">        err_code |= RD_ERROR_INTERNAL;</a>
<a name="ln119">    }</a>
<a name="ln120"> </a>
<a name="ln121">    *output_length = RE_5_DATA_LENGTH;</a>
<a name="ln122">    return err_code;</a>
<a name="ln123">}</a>
<a name="ln124">#endif</a>
<a name="ln125"> </a>
<a name="ln126">#if RE_8_ENABLED</a>
<a name="ln127">#ifndef APP_8_KEY</a>
<a name="ln128">// &quot;RuuviComRuuviTag&quot;</a>
<a name="ln129">#define APP_8_KEY { 0x52, 0x75, 0x75, 0x76, 0x69, 0x43, 0x6F, 0x6D, 0x52, 0x75, 0x75, 0x76, 0x69, 0x54, 0x61, 0x67}</a>
<a name="ln130">#endif</a>
<a name="ln131">static const uint8_t ep_8_key[RE_8_CIPHERTEXT_LENGTH] = APP_8_KEY;</a>
<a name="ln132"> </a>
<a name="ln133">TESTABLE_STATIC rd_status_t</a>
<a name="ln134">ep_8_key_generate (uint8_t * const key)</a>
<a name="ln135">{</a>
<a name="ln136">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln137">    memcpy (key, ep_8_key, RE_8_CIPHERTEXT_LENGTH);</a>
<a name="ln138">    uint64_t device_id = 0;</a>
<a name="ln139">    err_code |= ri_comm_id_get (&amp;device_id);</a>
<a name="ln140"> </a>
<a name="ln141">    for (uint8_t ii = 0U; ii &lt; 8; ii++)</a>
<a name="ln142">    {</a>
<a name="ln143">        key[ii] = key[ii] ^ ( (device_id &gt;&gt; (ii * 8U)) &amp; 0xFFU);</a>
<a name="ln144">    }</a>
<a name="ln145"> </a>
<a name="ln146">    return err_code;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">TESTABLE_STATIC rd_status_t</a>
<a name="ln150">encode_to_8 (uint8_t * const output,</a>
<a name="ln151">             size_t * const output_length,</a>
<a name="ln152">             const rd_sensor_data_t * const data)</a>
<a name="ln153">{</a>
<a name="ln154">    static uint16_t ep_8_measurement_count = 0;</a>
<a name="ln155">    uint8_t final_key[RE_8_CIPHERTEXT_LENGTH] = { 0 };</a>
<a name="ln156">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln157">    re_status_t enc_code = RE_SUCCESS;</a>
<a name="ln158">    re_8_data_t ep_data = {0};</a>
<a name="ln159">    ep_8_measurement_count++;</a>
<a name="ln160">    ep_8_measurement_count %= (RE_8_SEQCTR_MAX + 1);</a>
<a name="ln161">    ep_data.humidity_rh       = rd_sensor_data_parse (data, RD_SENSOR_HUMI_FIELD);</a>
<a name="ln162">    ep_data.pressure_pa       = rd_sensor_data_parse (data, RD_SENSOR_PRES_FIELD);</a>
<a name="ln163">    ep_data.temperature_c     = rd_sensor_data_parse (data, RD_SENSOR_TEMP_FIELD);</a>
<a name="ln164">    ep_data.message_counter = ep_8_measurement_count;</a>
<a name="ln165">    uint8_t mvtctr = (uint8_t) (app_sensor_event_count_get() % (RE_8_MVTCTR_MAX + 1));</a>
<a name="ln166">    ep_data.movement_count    = mvtctr;</a>
<a name="ln167">    err_code |= ep_8_key_generate (final_key);</a>
<a name="ln168">    err_code |= ri_radio_address_get (&amp;ep_data.address);</a>
<a name="ln169">    err_code |= ri_adv_tx_power_get (&amp;ep_data.tx_power);</a>
<a name="ln170">    err_code |= rt_adc_vdd_get (&amp;ep_data.battery_v);</a>
<a name="ln171">    enc_code |= re_8_encode (output,</a>
<a name="ln172">                             &amp;ep_data,</a>
<a name="ln173">                             &amp;app_data_encrypt,</a>
<a name="ln174">                             final_key,</a>
<a name="ln175">                             RE_8_CIPHERTEXT_LENGTH);</a>
<a name="ln176"> </a>
<a name="ln177">    if (RE_SUCCESS != enc_code)</a>
<a name="ln178">    {</a>
<a name="ln179">        err_code |= RD_ERROR_INTERNAL;</a>
<a name="ln180">    }</a>
<a name="ln181"> </a>
<a name="ln182">    *output_length = RE_5_DATA_LENGTH;</a>
<a name="ln183">    return err_code;</a>
<a name="ln184">}</a>
<a name="ln185">#endif</a>
<a name="ln186"> </a>
<a name="ln187">#if RE_FA_ENABLED</a>
<a name="ln188">#ifndef APP_FA_KEY</a>
<a name="ln189">#define APP_FA_KEY {00, 11, 22, 33, 44, 55, 66, 77, 88, 99, 11, 12, 13, 14, 15, 16}</a>
<a name="ln190">#endif</a>
<a name="ln191">static const uint8_t ep_fa_key[RE_FA_CIPHERTEXT_LENGTH] = APP_FA_KEY;</a>
<a name="ln192"> </a>
<a name="ln193">TESTABLE_STATIC rd_status_t</a>
<a name="ln194">encode_to_fa (uint8_t * const output,</a>
<a name="ln195">              size_t * const output_length,</a>
<a name="ln196">              const rd_sensor_data_t * const data)</a>
<a name="ln197">{</a>
<a name="ln198">    static uint8_t ep_fa_measurement_count = 0;</a>
<a name="ln199">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln200">    re_status_t enc_code = RE_SUCCESS;</a>
<a name="ln201">    re_fa_data_t ep_data = {0};</a>
<a name="ln202">    ep_fa_measurement_count++;</a>
<a name="ln203">    ep_fa_measurement_count %= 0xFFU;</a>
<a name="ln204">    ep_data.accelerationx_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_X_FIELD);</a>
<a name="ln205">    ep_data.accelerationy_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Y_FIELD);</a>
<a name="ln206">    ep_data.accelerationz_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Z_FIELD);</a>
<a name="ln207">    ep_data.humidity_rh       = rd_sensor_data_parse (data, RD_SENSOR_HUMI_FIELD);</a>
<a name="ln208">    ep_data.pressure_pa       = rd_sensor_data_parse (data, RD_SENSOR_PRES_FIELD);</a>
<a name="ln209">    ep_data.temperature_c     = rd_sensor_data_parse (data, RD_SENSOR_TEMP_FIELD);</a>
<a name="ln210">    ep_data.message_counter   = ep_fa_measurement_count;</a>
<a name="ln211">    err_code |= rt_adc_vdd_get (&amp;ep_data.battery_v);</a>
<a name="ln212">    err_code |= ri_radio_address_get (&amp;ep_data.address);</a>
<a name="ln213">    enc_code |= re_fa_encode (output,</a>
<a name="ln214">                              &amp;ep_data,</a>
<a name="ln215">                              &amp;app_data_encrypt,</a>
<a name="ln216">                              ep_fa_key,</a>
<a name="ln217">                              RE_FA_CIPHERTEXT_LENGTH); //!&lt; Cipher length == key lenght</a>
<a name="ln218"> </a>
<a name="ln219">    if (RE_SUCCESS != enc_code)</a>
<a name="ln220">    {</a>
<a name="ln221">        err_code |= RD_ERROR_INTERNAL;</a>
<a name="ln222">    }</a>
<a name="ln223"> </a>
<a name="ln224">    *output_length = RE_FA_DATA_LENGTH;</a>
<a name="ln225">    return err_code;</a>
<a name="ln226">}</a>
<a name="ln227">#endif</a>
<a name="ln228"> </a>
<a name="ln229">rd_status_t app_dataformat_encode (uint8_t * const output,</a>
<a name="ln230">                                   size_t * const output_length,</a>
<a name="ln231">                                   const rd_sensor_data_t * const p_data,</a>
<a name="ln232">                                   const app_dataformat_t format)</a>
<a name="ln233">{</a>
<a name="ln234">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln235"> </a>
<a name="ln236">    switch (format)</a>
<a name="ln237">    {</a>
<a name="ln238">#       if RE_3_ENABLED</a>
<a name="ln239"> </a>
<a name="ln240">        case DF_3:</a>
<a name="ln241">            err_code |= encode_to_3 (output, output_length, p_data);</a>
<a name="ln242">            break;</a>
<a name="ln243">#       endif</a>
<a name="ln244">#       if RE_5_ENABLED</a>
<a name="ln245"> </a>
<a name="ln246">        case DF_5:</a>
<a name="ln247">            err_code |= encode_to_5 (output, output_length, p_data);</a>
<a name="ln248">            break;</a>
<a name="ln249">#       endif</a>
<a name="ln250">#       if RE_8_ENABLED</a>
<a name="ln251"> </a>
<a name="ln252">        case DF_8:</a>
<a name="ln253">            err_code |= encode_to_8 (output, output_length, p_data);</a>
<a name="ln254">            break;</a>
<a name="ln255">#       endif</a>
<a name="ln256">#       if RE_FA_ENABLED</a>
<a name="ln257"> </a>
<a name="ln258">        case DF_FA:</a>
<a name="ln259">            err_code |= encode_to_fa (output, output_length, p_data);</a>
<a name="ln260">            break;</a>
<a name="ln261">#       endif</a>
<a name="ln262"> </a>
<a name="ln263">        default:</a>
<a name="ln264">            err_code |= RD_ERROR_NOT_ENABLED;</a>
<a name="ln265">    }</a>
<a name="ln266"> </a>
<a name="ln267">    return err_code;</a>
<a name="ln268">}</a>

</code></pre>
<div class="balloon" rel="24"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2615/" target="_blank">V2615</a> A compatible declaration should be visible when an object or function with external linkage is defined.</p></div>
<div class="balloon" rel="47"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="55"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'formats'.</p></div>
<div class="balloon" rel="55"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'state'.</p></div>
<div class="balloon" rel="85"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="101"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '%=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="109"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '%' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="141"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="143"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> Value of the expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="160"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="160"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '((0xFFFEU) + 1)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="165"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="203"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2572/" target="_blank">V2572</a> The value of the '0xFFU' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="236"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2520/" target="_blank">V2520</a> Every switch-clause should be terminated by an unconditional 'break' statement.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
