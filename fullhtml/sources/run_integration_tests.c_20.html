
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>run_integration_tests.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;app_config.h&quot;</a>
<a name="ln2">#include &quot;app_sensor.h&quot;</a>
<a name="ln3">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln4">#include &quot;ruuvi_driver_enabled_modules.h&quot;</a>
<a name="ln5">#include &quot;ruuvi_driver_sensor_test.h&quot;</a>
<a name="ln6">#include &quot;run_integration_tests.h&quot;</a>
<a name="ln7">#include &quot;ruuvi_interface_communication_ble_advertising_test.h&quot;</a>
<a name="ln8">#include &quot;ruuvi_interface_communication_ble_advertising.h&quot;</a>
<a name="ln9">#include &quot;ruuvi_interface_communication_ble_gatt_test.h&quot;</a>
<a name="ln10">#include &quot;ruuvi_interface_communication_ble_gatt.h&quot;</a>
<a name="ln11">#include &quot;ruuvi_interface_communication_nfc_test.h&quot;</a>
<a name="ln12">#include &quot;ruuvi_interface_communication_radio_test.h&quot;</a>
<a name="ln13">#include &quot;ruuvi_interface_communication_uart_test.h&quot;</a>
<a name="ln14">#include &quot;ruuvi_interface_gpio_test.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_interface_gpio_interrupt_test.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_interface_gpio_pwm_test.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_interface_flash_test.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_interface_i2c.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_log.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_power_test.h&quot;</a>
<a name="ln21">#include &quot;ruuvi_interface_rtc.h&quot;</a>
<a name="ln22">#include &quot;ruuvi_interface_scheduler_test.h&quot;</a>
<a name="ln23">#include &quot;ruuvi_interface_spi.h&quot;</a>
<a name="ln24">#include &quot;ruuvi_interface_timer_test.h&quot;</a>
<a name="ln25">#include &quot;ruuvi_interface_watchdog.h&quot;</a>
<a name="ln26">#include &quot;ruuvi_interface_yield.h&quot;</a>
<a name="ln27">#include &quot;ruuvi_library.h&quot;</a>
<a name="ln28">#include &quot;ruuvi_library_test.h&quot;</a>
<a name="ln29">#include &quot;ruuvi_task_gpio.h&quot;</a>
<a name="ln30">#include &quot;ruuvi_task_sensor.h&quot;</a>
<a name="ln31"> </a>
<a name="ln32">/**</a>
<a name="ln33"> * @addtogroup integration_test</a>
<a name="ln34"> */</a>
<a name="ln35"> </a>
<a name="ln36">/** @{ */</a>
<a name="ln37"> </a>
<a name="ln38">/**</a>
<a name="ln39"> * \@file run_integration_test.h</a>
<a name="ln40"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln41"> * @date 2020-02-03</a>
<a name="ln42"> * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln43"> */</a>
<a name="ln44"> </a>
<a name="ln45">#ifndef RUUVI_RUN_TESTS</a>
<a name="ln46">// Dummy declaration to compile without access to function.</a>
<a name="ln47">void app_sensor_ctx_get (rt_sensor_ctx_t *** m_sensors, size_t * num_sensors);</a>
<a name="ln48">#endif</a>
<a name="ln49"> </a>
<a name="ln50">#define LOG_PRINT_DELAY_MS (10U)</a>
<a name="ln51"> </a>
<a name="ln52">void on_integration_test_wdt (void)</a>
<a name="ln53">{</a>
<a name="ln54">}</a>
<a name="ln55"> </a>
<a name="ln56">static inline void LOG (const char * const msg)</a>
<a name="ln57">{</a>
<a name="ln58">    ri_log (RI_LOG_LEVEL_INFO, msg);</a>
<a name="ln59">    ri_delay_ms (LOG_PRINT_DELAY_MS); // Avoid overflowing log buffer.</a>
<a name="ln60">}</a>
<a name="ln61"> </a>
<a name="ln62">/** @brief Print test open JSON to console */</a>
<a name="ln63">void integration_test_start (void)</a>
<a name="ln64">{</a>
<a name="ln65">    ri_watchdog_init (APP_WDT_INTERVAL_MS, &amp;on_integration_test_wdt);</a>
<a name="ln66">    ri_log_init (APP_LOG_LEVEL);</a>
<a name="ln67">    ri_yield_init();</a>
<a name="ln68">    LOG (&quot;{\r\n\&quot;firmware\&quot;:\&quot;&quot; APP_FW_NAME &quot; &quot; APP_FW_VERSION &quot;\&quot;,\r\n&quot;);</a>
<a name="ln69">    LOG (&quot;\&quot;compiled_on\&quot;:\&quot;&quot; __DATE__ &quot; &quot;__TIME__&quot;\&quot;,\r\n&quot;);</a>
<a name="ln70">    LOG (&quot;\&quot;board\&quot;:\&quot;&quot; RB_MODEL_STRING &quot;\&quot;,\r\n&quot;);</a>
<a name="ln71">    LOG (&quot;\&quot;ruuvi.boards.c\&quot;:\&quot;&quot; RUUVI_BOARDS_SEMVER &quot;\&quot;,\r\n&quot;);</a>
<a name="ln72">    LOG (&quot;\&quot;ruuvi.drivers.c\&quot;:\&quot;&quot; RUUVI_DRIVERS_SEMVER &quot;\&quot;,\r\n&quot;);</a>
<a name="ln73">    LOG (&quot;\&quot;ruuvi.libraries.c\&quot;:\&quot;&quot; RUUVI_LIBRARIES_SEMVER &quot;\&quot;,\r\n&quot;);</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76">/** @brief Print test close JSON to console */</a>
<a name="ln77">void integration_test_stop (void)</a>
<a name="ln78">{</a>
<a name="ln79">    LOG (&quot;}\r\n&quot;);</a>
<a name="ln80">    ri_yield_uninit();</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83">static void integration_test_power (void)</a>
<a name="ln84">{</a>
<a name="ln85">    ri_power_regulators_t regs = {0};</a>
<a name="ln86">#   if (RB_DCDC_INTERNAL_INSTALLED)</a>
<a name="ln87">    regs.DCDC_INTERNAL = 1;</a>
<a name="ln88">#endif</a>
<a name="ln89">#   if (RB_DCDC_HV_INSTALLED)</a>
<a name="ln90">    regs.DCDC_HV = 1;</a>
<a name="ln91">#endif</a>
<a name="ln92">    ri_power_run_integration_test (&amp;LOG, regs);</a>
<a name="ln93">}</a>
<a name="ln94"> </a>
<a name="ln95">static void integration_test_sensors (void)</a>
<a name="ln96">{</a>
<a name="ln97">    rt_sensor_ctx_t ** p_sensors;</a>
<a name="ln98">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln99">    size_t num_sensors = 0;</a>
<a name="ln100">    LOG (&quot;\&quot;sensors\&quot;: {\r\n&quot;);</a>
<a name="ln101">    err_code |= rt_gpio_init();</a>
<a name="ln102">    err_code |= app_sensor_init();</a>
<a name="ln103">    app_sensor_ctx_get (&amp;p_sensors, &amp;num_sensors);</a>
<a name="ln104"> </a>
<a name="ln105">    for (size_t ii = 0; ii &lt; num_sensors; ii++)</a>
<a name="ln106">    {</a>
<a name="ln107">        rd_sensor_run_integration_test (&amp;LOG, p_sensors[ii]);</a>
<a name="ln108"> </a>
<a name="ln109">        if (ii &lt; (num_sensors - 1))</a>
<a name="ln110">        {</a>
<a name="ln111">            LOG (&quot;,\r\n&quot;);</a>
<a name="ln112">        }</a>
<a name="ln113">        else</a>
<a name="ln114">        {</a>
<a name="ln115">            LOG (&quot;\r\n&quot;);</a>
<a name="ln116">        }</a>
<a name="ln117"> </a>
<a name="ln118">        // Let logs print out.</a>
<a name="ln119">        ri_delay_ms (10);</a>
<a name="ln120">    }</a>
<a name="ln121"> </a>
<a name="ln122">    app_sensor_uninit();</a>
<a name="ln123">    ri_gpio_interrupt_uninit();</a>
<a name="ln124">    ri_gpio_uninit();</a>
<a name="ln125">    (void) ri_rtc_uninit();</a>
<a name="ln126">    rd_sensor_timestamp_function_set (NULL);</a>
<a name="ln127">    LOG (&quot;},\r\n&quot;);</a>
<a name="ln128">}</a>
<a name="ln129"> </a>
<a name="ln130">/** @brief Run driver integration tests */</a>
<a name="ln131">static void driver_integration_tests_run (void)</a>
<a name="ln132">{</a>
<a name="ln133">    ri_flash_run_integration_test (&amp;LOG);</a>
<a name="ln134">    integration_test_power();</a>
<a name="ln135">    ri_timer_integration_test_run (&amp;LOG);</a>
<a name="ln136">    ri_scheduler_run_integration_test (&amp;LOG);</a>
<a name="ln137">    ri_watchdog_feed();</a>
<a name="ln138">    integration_test_sensors();</a>
<a name="ln139">    ri_communication_radio_run_integration_test (&amp;LOG);</a>
<a name="ln140">    ri_communication_ble_advertising_run_integration_test (&amp;LOG, RI_RADIO_BLE_1MBPS);</a>
<a name="ln141">    ri_communication_ble_advertising_run_integration_test (&amp;LOG, RI_RADIO_BLE_2MBPS);</a>
<a name="ln142">    ri_watchdog_feed();</a>
<a name="ln143">    ri_communication_ble_gatt_run_integration_test (&amp;LOG, RI_RADIO_BLE_1MBPS);</a>
<a name="ln144">    ri_watchdog_feed();</a>
<a name="ln145">    ri_communication_ble_gatt_run_integration_test (&amp;LOG, RI_RADIO_BLE_2MBPS);</a>
<a name="ln146">#ifdef S140</a>
<a name="ln147">    ri_communication_ble_advertising_run_integration_test (&amp;LOG, RI_RADIO_BLE_125KBPS);</a>
<a name="ln148">    ri_watchdog_feed();</a>
<a name="ln149">    ri_communication_ble_gatt_run_integration_test (&amp;LOG, RI_RADIO_BLE_125KBPS);</a>
<a name="ln150">#endif</a>
<a name="ln151"> </a>
<a name="ln152">    if ( (RI_GPIO_ID_UNUSED != RB_GPIO_TEST_INPUT)</a>
<a name="ln153">            &amp;&amp; (RI_GPIO_ID_UNUSED != RB_GPIO_TEST_OUTPUT))</a>
<a name="ln154">    {</a>
<a name="ln155">        ri_communication_uart_run_integration_test (&amp;LOG, RB_GPIO_TEST_INPUT,</a>
<a name="ln156">                RB_GPIO_TEST_OUTPUT);</a>
<a name="ln157">        ri_gpio_run_integration_test (&amp;LOG, RB_GPIO_TEST_INPUT, RB_GPIO_TEST_OUTPUT);</a>
<a name="ln158">        ri_gpio_interrupt_run_integration_test (&amp;LOG, RB_GPIO_TEST_INPUT, RB_GPIO_TEST_OUTPUT);</a>
<a name="ln159">        ri_gpio_pwm_run_integration_test (&amp;LOG, RB_GPIO_TEST_INPUT, RB_GPIO_TEST_OUTPUT);</a>
<a name="ln160">    }</a>
<a name="ln161"> </a>
<a name="ln162">#if RB_NFC_INTERNAL_INSTALLED</a>
<a name="ln163">    ri_watchdog_feed();</a>
<a name="ln164">    ri_communication_nfc_run_integration_test (&amp;LOG);</a>
<a name="ln165">#endif</a>
<a name="ln166">}</a>
<a name="ln167"> </a>
<a name="ln168">/** @brief Run library integration tests */</a>
<a name="ln169">static void library_integration_tests_run (void)</a>
<a name="ln170">{</a>
<a name="ln171">    rl_test_all_run (&amp;LOG);</a>
<a name="ln172">}</a>
<a name="ln173"> </a>
<a name="ln174">void integration_tests_run (void)</a>
<a name="ln175">{</a>
<a name="ln176">    integration_test_start();</a>
<a name="ln177">    LOG (&quot;\&quot;libraries\&quot;: {\r\n&quot;);</a>
<a name="ln178">    library_integration_tests_run();</a>
<a name="ln179">    LOG (&quot;},\r\n&quot;);</a>
<a name="ln180">    ri_delay_ms (10);</a>
<a name="ln181">    LOG (&quot;\&quot;drivers\&quot;: {\r\n&quot;);</a>
<a name="ln182">    driver_integration_tests_run();</a>
<a name="ln183">    LOG (&quot;}\r\n&quot;);</a>
<a name="ln184">    integration_test_stop();</a>
<a name="ln185">}</a>
<a name="ln186"> </a>
<a name="ln187">/** @}*/</a>

</code></pre>
<div class="balloon" rel="47"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2515/" target="_blank">V2515</a> Declaration 'm_sensors' should contain no more than two levels of pointer nesting.</p></div>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2615/" target="_blank">V2615</a> A compatible declaration should be visible when an object or function with external linkage is defined.</p></div>
<div class="balloon" rel="63"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2615/" target="_blank">V2615</a> A compatible declaration should be visible when an object or function with external linkage is defined.</p></div>
<div class="balloon" rel="77"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2615/" target="_blank">V2615</a> A compatible declaration should be visible when an object or function with external linkage is defined.</p></div>
<div class="balloon" rel="87"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="109"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="152"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '!=' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="153"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2568/" target="_blank">V2568</a> Both operands of the '!=' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="152"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2594/" target="_blank">V2594</a> Controlling expressions should not be invariant. The result of the expression in the 'if' statement is always false.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
