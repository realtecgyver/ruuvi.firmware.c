
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ruuvi_interface_timer.h</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#ifndef RUUVI_INTERFACE_TIMER_H</a>
<a name="ln2">#define RUUVI_INTERFACE_TIMER_H</a>
<a name="ln3">/**</a>
<a name="ln4"> * @defgroup timer Interface for timing tasks to be exeuted later.</a>
<a name="ln5"> *</a>
<a name="ln6"> */</a>
<a name="ln7">/** @{ */</a>
<a name="ln8">/**</a>
<a name="ln9"> * @file ruuvi_interface_timer.h</a>
<a name="ln10"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln11"> * @date 2020-07-14</a>
<a name="ln12"> * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln13"> * @brief Interface functions to timer.</a>
<a name="ln14"> *</a>
<a name="ln15"> * Timer abstraction. Allows creating single-shot and repeated timers which call a function at interval.</a>
<a name="ln16"> * The timer will run in interrupt context, if you need to use peripherals or spend a lot of</a>
<a name="ln17"> * time in timer function you should use ri_scheduler to run the functions without blocking</a>
<a name="ln18"> * timing-critical tasks.</a>
<a name="ln19"> *</a>
<a name="ln20"> * Typical usage:</a>
<a name="ln21"> * @code</a>
<a name="ln22"> * static ri_timer_id_t m_timer;</a>
<a name="ln23"> *</a>
<a name="ln24"> * static void do_lots_of_things_in_scheduler (void * p_event_data, uint16_t event_size)</a>
<a name="ln25"> * {</a>
<a name="ln26"> *     write_to_i2c_device((uint8_t*) event_data, event_size);</a>
<a name="ln27"> * }</a>
<a name="ln28"> *</a>
<a name="ln29"> * static void timer_isr(void * const p_context)</a>
<a name="ln30"> * {</a>
<a name="ln31"> *     // Slow I2C write in scheduler</a>
<a name="ln32"> *     i2c_tx_t* tx = (i2c_tx_t*) p_context;</a>
<a name="ln33"> *     uint16_t event_size = (p_context[0] &lt;&lt; 8) + p_context[1];</a>
<a name="ln34"> *     uint8_t* p_event_data = &amp;(p_context[2]);</a>
<a name="ln35"> *     ri_scheduler_event_put (p_event_data, event_size, &amp;do_lots_of_things_in_scheduler);</a>
<a name="ln36"> *     // Fast GPIO operation can be done here.</a>
<a name="ln37"> *     blink_led_right_away();</a>
<a name="ln38"> * }</a>
<a name="ln39"> *</a>
<a name="ln40"> * // Write 10 NULLs over I2C in a scheduler 10 seconds from now.</a>
<a name="ln41"> * rd_status_t start_my_timer(void)</a>
<a name="ln42"> * {</a>
<a name="ln43"> *   rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln44"> *   static i2c_tx_t tx =</a>
<a name="ln45"> *   {</a>
<a name="ln46"> *      .write_len = 10;</a>
<a name="ln47"> *      .data = {0}</a>
<a name="ln48"> *   }</a>
<a name="ln49"> *   err_code |= ri_timer_init();</a>
<a name="ln50"> *   // Note: Address of timer</a>
<a name="ln51"> *   err_code |= ri_timer_create (&amp;m_timer, RI_TIMER_MODE_SINGLE_SHOT, &amp;timer_isr);</a>
<a name="ln52"> *   // Note: Value of timer, statically allocated data as context.</a>
<a name="ln53"> *   err_code |= ri_timer_start (m_timer, (10 * 1000U), &amp;tx);</a>
<a name="ln54"> *   return err_code</a>
<a name="ln55"> * }</a>
<a name="ln56"> * @endcode</a>
<a name="ln57"> *</a>
<a name="ln58"> *</a>
<a name="ln59"> */</a>
<a name="ln60"> </a>
<a name="ln61"> </a>
<a name="ln62">#include &quot;ruuvi_driver_enabled_modules.h&quot;</a>
<a name="ln63">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln64">#include &quot;ruuvi_driver_enabled_modules.h&quot;</a>
<a name="ln65">#include &lt;stdbool.h&gt;</a>
<a name="ln66"> </a>
<a name="ln67">/** @brief Enable implementation selected by application */</a>
<a name="ln68">#if RI_TIMER_ENABLED</a>
<a name="ln69">#define RUUVI_NRF5_SDK15_TIMER_ENABLED RUUVI_NRF5_SDK15_ENABLED</a>
<a name="ln70">#endif</a>
<a name="ln71"> </a>
<a name="ln72">/** @brief Single or continuous execution of task. */</a>
<a name="ln73">typedef enum</a>
<a name="ln74">{</a>
<a name="ln75">    RI_TIMER_MODE_SINGLE_SHOT,</a>
<a name="ln76">    RI_TIMER_MODE_REPEATED</a>
<a name="ln77">} ri_timer_mode_t;</a>
<a name="ln78"> </a>
<a name="ln79">typedef void * ri_timer_id_t; ///&lt; Pointer to timer data</a>
<a name="ln80"> </a>
<a name="ln81">/**</a>
<a name="ln82"> * @brief Function to be called when timer times out.</a>
<a name="ln83"> *</a>
<a name="ln84"> * @param p_context pointer to context to be passed to handler, can be NULL.</a>
<a name="ln85"> */</a>
<a name="ln86">typedef void (*ruuvi_timer_timeout_handler_t) (void * const p_context);</a>
<a name="ln87"> </a>
<a name="ln88">/* @brief Calls initialization as required by application timers.</a>
<a name="ln89"> *</a>
<a name="ln90"> * After initialization, timers can be created, started and stopped.</a>
<a name="ln91"> *</a>
<a name="ln92"> * @retval RD_SUCCESS on success.</a>
<a name="ln93"> * @retval RD_ERROR_INVALID_STATE if timers are already initialized.</a>
<a name="ln94"> */</a>
<a name="ln95">rd_status_t ri_timer_init (void);</a>
<a name="ln96"> </a>
<a name="ln97">/* @brief Calls uninitialization as required by application timers</a>
<a name="ln98"> *</a>
<a name="ln99"> * Deletes state of timers and stops hardware timers if possible.</a>
<a name="ln100"> *</a>
<a name="ln101"> **/</a>
<a name="ln102">rd_status_t ri_timer_uninit (void);</a>
<a name="ln103"> </a>
<a name="ln104">/**</a>
<a name="ln105"> * @brief Check if timer is initialized.</a>
<a name="ln106"> *</a>
<a name="ln107"> * @retval true if timers have been successfully initialized.</a>
<a name="ln108"> * @retval false if timer is not initialized.</a>
<a name="ln109"> */</a>
<a name="ln110">bool ri_timer_is_init (void);</a>
<a name="ln111"> </a>
<a name="ln112">/* @brief Function for creating a timer instance.</a>
<a name="ln113"> *</a>
<a name="ln114"> * Timers may be statically or dynamically allocated, if statically allocated this will</a>
<a name="ln115"> * only return a handle to instance. If dynamically, this will allocate memory for new</a>
<a name="ln116"> * instance.</a>
<a name="ln117"> *</a>
<a name="ln118"> * @param[out] p_timer_id pointer to timer id, outputs ID which can be used to control the timer</a>
<a name="ln119"> * @param[in] mode mode of the timer, single shot or repeated</a>
<a name="ln120"> * @param[in] timeout_handler function which gets called</a>
<a name="ln121"> * @return RD_SUCCESS if timer was created</a>
<a name="ln122"> * @return RD_ERROR_RESOURCES if no more timers can be allocated</a>
<a name="ln123"> * @return RD_ERROR_INVALID_STATE if timers have not been initialized</a>
<a name="ln124"> * @return error code from stack on other error</a>
<a name="ln125"> */</a>
<a name="ln126">rd_status_t ri_timer_create (ri_timer_id_t * p_timer_id,</a>
<a name="ln127">                             ri_timer_mode_t mode,</a>
<a name="ln128">                             ruuvi_timer_timeout_handler_t timeout_handler);</a>
<a name="ln129"> </a>
<a name="ln130">/**</a>
<a name="ln131"> * @brief Start given timer at a mode defined in ri_timer_create.</a>
<a name="ln132"> *</a>
<a name="ln133"> * This operation is ignored if timer is already running.</a>
<a name="ln134"> *</a>
<a name="ln135"> * @param[in] timer_id id of timer to control</a>
<a name="ln136"> * @param[in] ms timeout (or interval) of timer in milliseconds.</a>
<a name="ln137"> * @param[in] context Pointer passed to timer handler.</a>
<a name="ln138"> *</a>
<a name="ln139"> * Return RD_SUCCESS on success, error code on start.</a>
<a name="ln140"> */</a>
<a name="ln141">rd_status_t ri_timer_start (ri_timer_id_t timer_id,</a>
<a name="ln142">                            uint32_t ms,</a>
<a name="ln143">                            void * const context);</a>
<a name="ln144"> </a>
<a name="ln145">/**</a>
<a name="ln146"> * Stop a running timer.</a>
<a name="ln147"> *</a>
<a name="ln148"> * @param timer_id id of timer to stop</a>
<a name="ln149"> * returns RD_SUCCESS on success, error code from stack on error</a>
<a name="ln150"> */</a>
<a name="ln151">rd_status_t ri_timer_stop (ri_timer_id_t timer_id);</a>
<a name="ln152">/** @} */</a>
<a name="ln153">#endif</a>

</code></pre>
<div class="balloon" rel="31"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2587/" target="_blank">V2587</a> The '//' and '/*' character sequences should not appear within comments.</p></div>
<div class="balloon" rel="36"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2587/" target="_blank">V2587</a> The '//' and '/*' character sequences should not appear within comments.</p></div>
<div class="balloon" rel="40"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2587/" target="_blank">V2587</a> The '//' and '/*' character sequences should not appear within comments.</p></div>
<div class="balloon" rel="50"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2587/" target="_blank">V2587</a> The '//' and '/*' character sequences should not appear within comments.</p></div>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v2587/" target="_blank">V2587</a> The '//' and '/*' character sequences should not appear within comments.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
